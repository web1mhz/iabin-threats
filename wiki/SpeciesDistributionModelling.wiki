#labels sdm,R
#sidebar TableOfContents

Documentation on how the Species Distribution Modelling (SDM) was done.

[http://code.google.com/p/iabin-threats/wiki/SpeciesDistributionModelling?wl=en http://iabin-threats.googlecode.com/svn/wiki/resources/gb.gif]
[http://code.google.com/p/iabin-threats/wiki/SpeciesDistributionModelling?wl=es http://iabin-threats.googlecode.com/svn/wiki/resources/es.gif]

<wiki:toc />

= Introduction =

Here we provide the technical details for the SDM and the consecutive threat assessment. Broadly the speaking the analysis can be divided into four steps:
 * Preparation of the data
 * SDM and their analysis
 * Calculating threats for each species
 * Calculating the percentage of area protected for each species
Below each of this steps will be described in more detail and reference is given to the source code.
 
= Details =
== Software ==
All were accomplished using the following software tools:
  * R (in particular packages raster, spgrass6, and snowfall)
  * MaxEnt 3.3.1
  * GRASS 6.4
  * Bash Shell

== Data preparation and organisation ==
=== Directory structure ===
Within the root directory _iabin_ there are the following directories located.
 * *parameters* This directory contains the file _parameters.R_. In this file all paths, variables concenring the analysis (i.e. number of points used in the Maxent model, the type of environmental variables used in the Maxent model) are stored.
 * *results* This directory holds a folder for each run of the analysis labelled with the date when the analysis was started. If several runs were performed at the same day, a number is added to the date. Within the folder for each run, an other folder is created for each species, labelled with its unique species id.
 * *src* within the _src_ directory there are two further directories: _src/lib_ containing Maxent and _src/scripts_ containing all scripts that were used and area also available here.

=== Workflow ===
  * *Organising species data:* The presence records from GBIF and IABIN SSTN database was split by species. For each species a directory was created containing the presence points for that species and _info.txt_ file. In the _info.txt_ file the initial parameters of the species (i.e. kingdom, family, genus, number of presence points) are saved. During the modelling process results for the species are written in this file. 
  * *Getting background points:* MaxEnt requires a random background sample. For each species it was determined in which which biomes (according to the wwf classification) the presence points fell. From these biomes a random sample of 10000 was drawn for the background points.
  * *Extracting values of the climate variables:* The coordinates of all species and background points were merged. Using maxent the values for all 8 environmental variables were extracted. For each species for every presence and background point values of appropriate environmental variables were assigned.

== Processing ==
*01_main.R*: This script contains the whole work flow. Some functions are outsourced in other scripts, in order to reduce the code. The first part, until the evaluation of the Maxent models, is almost exclusively written R. The majority of the subsequent analysis is done with GRASS, hence the scripts are for a bash shell. The most important file is the file *parameters.R*. This file is sourced at the beginning of the process and contains all parameters and additional functions. El proceso de an√°lisis es el siguiente:
 * Task 9: the function `write.species.csv()` is applied to all species. It extracts the points for all species with more than 10 or more occurrence points, creates a folder for this species and stores the points in the subfolder training. The script is stored in *write_species_csv.R*.
 * Task 10-13: This part of the code creates the SWD files for the presence points and background points and creates the R batch scripts to run Maxent.
  # With the function `get.background(...)` for all species the background points are extracted from the same biomes where the presence points are found. The function is stored in *002_make_background.R*. `get.background()` can be parallelised with `sfApply()` from the snowfall package. 
  # Files that have now backgrounds, because there was an error are moved to the folder *no_bg* and will not be considered for the next steps of the analysis. 
  # The function `get.full.swd(...)` is being run twice. Once for the background points and once for the presence points. `get.full.swd()` is located in *002_get_background.R*. The function extracts all unique presence and absence points. For this points the values of the environmental layers are extracted. `get.full.swd()` relies on Maxent, and some Unix shell tools such as awk.
 # With the function `get.sp.swd()` the files produced in the last step are split again and a SWD file is created for each species for backgrounds points and presence points.
 # In the next loop for each server a folder is created, each folder contains for each availble core of the server a R BATCH file. They can be started with `R BATCH filename.R`. Species are equally distributed over all cores.
 * Task 15: For this part, R needs to be started from a grass shell. For each model the predictions are imported to grass and the evaluation statistics extracted and written to the *info.txt* for each species. 
 * Task 14: Here a convex hull for the all presence points is calculated. This hull is buffered by 300 km and the raster with the predictions is clipped to the buffered convex hull.
 * Task 16: The species richness for each genus is calculated
 * Task 17: The species richness for each species type is calculated
 * Task 18: For each species the area under each each level (no, low, mid, high) of each treat is calculated. Additionally the fraction of the area that is still available and already lost is calculated.
 * Task 19: For each species the mean occurrence probability inside and outside of protected areas is calculated. Additionally for each species the percentage of area protected is calculated.
 * Task 20: For each protected area the mean species richness and the mean of each threat is calculated.
 * Task 21: For each species type the mean species richness is calculated and the percent that is protected is calculated.